
-- ====================== 文件信息 ======================

-- 剑侠情缘online IB 版本限制托管的头文件
-- Edited by peres
-- 2006/10/30 PM 15:42

-- 烟花。那一夜的烟花。
-- 她记得他在大雨的人群中，站在她的背后拥抱住她。
-- 他温暖的皮肤，他熟悉的味道。烟花照亮她的眼睛。
-- 一切无可挽回……

-- ======================================================

NUM_OFFLINE_PERMITREGION_MAX = 10;  -- 离不允许托管点的最小半径

aryLimitRegion = {
	--汴京
	[37]={
		{1630, 3187},--NPC 车夫	
		{1704, 3224},--NPC 车夫	
		{1595, 2994},--NPC 车夫	
		{1860, 2928},--NPC 车夫	
		{1755, 3043},--武林传人	
		{1806, 3098},--礼官	
		{1712, 3102},--铁匠	
		{1747, 3050},--铁匠	
		{1773, 3090},--药店	
		{1786, 3103},--杂货铺
		{1776, 3063},--武林新秀联赛官员	
		{1740, 3065},--试炼堂	
		{1646, 3050},--聂士陈	
		{1589, 3096},--小贩	
		{1784, 3042},--内阁尚书	
		{1641, 3145},--萍萍姑娘	
		{16620, 3019},--萍萍姑娘	
		{1713, 374},--萍萍姑娘	
		{1865, 2968},--萍萍姑娘	
		{1734, 3102},--野叟	
		{1693, 3212},--攻城车夫	
	},

	--大理
	[162]={
		{1669, 3124},--NPC 车夫	
		{1697, 3279},--NPC 车夫	
		{1469, 3269},--NPC 车夫	
		{1628, 3184},--武林传人	
		{1587, 3221},--礼官	
		{15599, 3262},--铁匠	
		{1449, 3211},--药店	
		{1535, 3201},--杂货铺
		{1651, 3226},--联赛使者	
		{1613, 3190},--试炼堂	
		{1574, 3227},--聂士陈	
		{1671, 3236},--小贩	
		{1651, 3226},--野叟	
		{1681, 3276},--攻城车夫	
	},

	--襄阳
	[78] = {
		{1509, 3140},--NPC 车夫	
		{1439, 3212},--NPC 车夫	
		{1598, 3378},--NPC 车夫	
		{1693, 3233},--NPC 车夫	
		{1609, 3259},--武林传人	
		{1541, 3247},--礼官	
		{1550, 3217},--铁匠	
		{1612, 3244},--药店	
		{1628, 3262},--杂货铺
		{1546, 3118},--武林新秀联赛官员	
		{1606, 3238},--试炼堂	
		{1511, 3208},--聂士陈	
		{1489, 3270},--小贩	
		{1594, 3289},--野叟	
		{1582, 3379},--攻城车夫	
		{1554, 3183},--神秘商人			
	},

	--成都
	[11]={
		{3196, 5194},--NPC 车夫	
		{3266, 5003},--NPC 车夫	
		{3027, 4960},--NPC 车夫	
		{3017, 5090},--NPC 车夫	
		{3135, 5045},--武林传人	
		{3126, 4994},--礼官	
		{3104, 5121},--铁匠	
		{3141, 5136},--药店	
		{3095, 5136},--杂货铺
		{3213, 5148},--联赛使者	
		{3109, 5059},--试炼堂	
		{3210, 4974},--聂士陈	
		{3180, 4947},--小贩	
		{3153, 5066},--野叟	
		{3185, 5182},--攻城车夫	
	},
	
	--扬州
	[80]={
		{1717, 3198},--NPC 车夫	
		{1592, 3195},--NPC 车夫	
		{1670, 2991},--NPC 车夫	
		{1825, 3064},--NPC 车夫	
		{1792, 3047},--武林传人	
		{1745, 3000},--礼官	
		{1689, 3170},--铁匠	
		{1773, 3079},--药店	
		{1701, 3022},--杂货铺
		{1754, 3035},--联赛使者	
		{1705, 3058},--试炼堂	
		{1702, 2962},--聂士陈	
		{1638, 3049},--小贩	
		{1743, 2966},--野叟	
		{1691, 3219},--攻城车夫	
	},
	
	--凤翔
	[1]={
		{1647, 3166},--NPC 车夫	
		{1557, 3108},--NPC 车夫	
		{1520, 3230},--NPC 车夫	
		{1652, 3281},--NPC 车夫	
		{1623, 3205},--武林传人	
		{1614, 3152},--礼官	
		{1618, 3196},--铁匠	
		{1604, 3190},--药店	
		{1559, 3206},--杂货铺
		{1671, 3218},--联赛使者	
		{1586, 3229},--试炼堂	
		{1507, 3198},--聂士陈	
		{1619, 3103},--小贩	
		{1618, 3090},--野叟	
		{1640, 3270},--攻城车夫	
	},
	
	--临安
	[176]={
		{1606, 3292},--NPC 车夫	
		{1372, 3329},--NPC 车夫	
		{1601, 2912},--NPC 车夫	
		{1353, 3014},--NPC 车夫	
		{1532, 3010},--武林传人	
		{1506, 2984},--礼官	
		{1683, 3220},--铁匠	
		{1332, 3060},--铁匠	
		{1520, 2986},--铁匠	
		{1685, 3319},--药店	
		{1474, 3362},--药店	
		{1544, 2964},--药店	
		{1615, 2977},--药店	
		{1340, 3165},--杂货铺
		{1457, 3259},--武林新秀联赛官员	
		{1592, 2944},--试炼堂	
		{1371, 3007},--聂士陈	
		{1387, 2961},--小贩	
		{1561, 2980},--野叟	
		{1689, 3291},--攻城车夫	
		{1654, 3263},--掌灯宫女	
		{1439, 3268},--掌灯宫女	
		{1384, 2979},--掌灯宫女	
		{1576, 2958},--掌灯宫女	
		{1314, 3195},--神秘铁匠	
		{1412, 3312},--武林盟主	
		{1442, 3061},--朱钱庄	
		{1478, 3237},--内阁尚书	
		{1312, 2848},--神秘商人
		{1657, 3261},--掌灯宫女
		{1577, 2957},--掌灯宫女
		{1439, 3267},--掌灯宫女
		{1385, 2977},--掌灯宫女
	},
	
	--巴陵县
	[53]={
		{1626, 3172},--野叟	
		{1629, 3195},--礼官	
		{1598, 3209},--药店	
		{1600, 3170},--杂货	
		{1578, 3236},--车夫	
	},
	
	--江新村
	[20]={
		{3538, 6231},--野叟	
		{3552, 6192},--礼官	
		{3469, 6164},--药店	
		{3370, 6256},--杂货	
		{3458, 6110},--车夫	
		{3522, 6117},--月老	
	},
	
	--永乐
	[99]={
		{1646, 3192},--野叟	
		{1614, 3177},--礼官	
		{1595, 3227},--药店	
		{1606, 3282},--杂货	
		{1630, 3304},--车夫	
		{1607, 3161},--	
	},
	
	--朱仙镇
	[100]={
		{1616, 3199},--野叟	
		{1621, 3181},--礼官	
		{1657, 3124},--药店	
		{1641, 3126},--杂货	
		{1610, 3097},--车夫	
		{1678, 3101},--车夫	
		{1719, 3217},--车夫	
		{1603, 3168},--车夫	
	},
	
	--稻香村
	[101]={
		{1677, 3143},--野叟	
		{1671, 3172},--礼官	
		{1679, 3196},--药店	
		{1639, 3144},--杂货	
		{1623, 3098},--车夫	
	},
	
	--龙门镇
	[121]={
		{1959, 4500},--野叟	
		{1958, 4517},--礼官	
		{1934, 4551},--药店	
		{1914, 4524},--杂货	
		{1924, 4527},--车夫	
		{1980, 4593},--车夫
	},
	
	--石鼓镇
	[123]={
		{1643, 3235},--野叟	
		{1606, 3227},--礼官	
		{1600, 3209},--药店	
		{1630, 3231},--杂货	
		{1658, 3244},--车夫	
	},
	
	--龙泉村
	[174]={
		{1608, 3200},--野叟	
		{1631, 3215},--礼官	
		{1572, 3253},--药店	
		{1566, 3202},--杂货	
		{1634, 3196},--车夫	
	},
--	-- 临安
--	[176]={
--		{1695, 3294},
--		{1373, 3333},
--		{1353, 3018},
--		{1602, 2912},
--		{1687, 3319},
--		{1476, 3363},
--		{1545, 2966},
--		{1615, 2976},
--		{1340, 3166},
--		{1505, 2982},
--	},
--
--	-- 汴京
--	[37]={
--		{1704, 3222},
--		{1632, 3185},
--		{1595, 2995},
--		{1862, 2927},
--		{1785, 3104},
--		{1773, 3091},
--		{1806, 3097},
--	},
--
--	-- 成都
--	[11]={
--		{3196, 5193},
--		{3018, 5089},
--		{3029, 4958},
--		{3261, 5004},
--		{3095, 5135},
--		{3141, 5134},
--		{3126, 4993},
--	},
--
--	-- 大理
--	[162]={
--		{1667, 3126},
--		{1468, 3271},
--		{1697, 3277},
--		{1535, 3202},
--		{1500, 3213},
--		{1586, 3221}
--	},
--	
--	-- 襄阳
--	[78]={
--		{1596, 3379},
--		{1439, 3214},
--		{1511, 3142},
--		{1689, 3236},
--		{1628, 3263},
--		{1612, 3245},
--		{1539, 3248},
--	},	
--
--	-- 凤翔
--	[1]={
--		{1651, 3279},
--		{1520, 3228},
--		{1557, 3108},
--		{1647, 3167},
--		{1559, 3206},
--		{1603, 3191},
--		{1614, 3151},
--	},	
--
--	-- 扬州
--	[80]={
--		{1718, 3201},
--		{1593, 3197},
--		{1669, 2990},
--		{1824, 3064},
--		{1691, 3169},
--		{1702, 3022},
--		{1743, 2995},
--	},	
--	
--	-- 南岳镇
--	[54]={
--		{1590, 3092},
--		{1639, 3142},
--		{1648, 3108},
--	},
--		
--	-- 龙泉村
--	[174]={
--		{1635, 3198},
--		{1594, 3228},
--		{1572, 3254},
--		{1631, 3216},
--	},
--	
--	-- 江津村
--	[20]={
--		{3459, 6113},
--		{3468, 6163},
--		{3370, 6255},
--		{3552, 6192},
--	},
--
--	-- 龙门镇
--	[121]={
--		{1925, 4427},
--		{1980, 4595},
--		{1914, 4524},
--		{1934, 4551},
--		{1957, 4518},
--	},
--
--	-- 石鼓镇
--	[153]={
--		{1631, 3179},
--		{1684, 3244},
--		{1600, 3209},
--		{1634, 3223},
--		{1606, 3228},
--	},
--	
--	-- 稻香村
--	[101]={
--		{1622, 3099},
--		{1679, 3196},
--		{1639, 3144},
--		{1671, 3173},
--	},
--	
--	-- 永乐镇
--	[99]={
--		{1608, 3163},
--		{1630, 3305},
--		{1595, 3227},
--		{1606, 3282},
--		{1614, 3177},
--	},
--	
--	-- 朱仙镇
--	[100]={
--		{1603, 3170},
--		{1611, 3099},
--		{1679, 3102},
--		{1720, 3217},
--		{1641, 3126},
--		{1657, 3124},
--		{1621, 3181},
--	},
--	
--	-- 巴陵县
--	[53]={
--		{1579, 3236},
--		{1598, 3209},
--		{1600, 3170},
--		{1629, 3195},
--	},
}


-- 检测玩家是否在限制区域内
function offlineCheckPermitRegion()
	local nMapId, nX, nY = GetWorldPos();
	local nLimitX, nLimitY = 0,0;
	local szDirection, nDistance = "", 0;
	local i=0;
	if aryLimitRegion[nMapId] then
		for i=1, getn(aryLimitRegion[nMapId]) do
			nLimitX = aryLimitRegion[nMapId][i][1];
			nLimitY = aryLimitRegion[nMapId][i][2];
			szDirection, nDistance = getDirection({nX, nY}, {nLimitX, nLimitY});
			-- 如果距离任何一点小于 10，则说明在禁止区域内
			if nDistance<=NUM_OFFLINE_PERMITREGION_MAX then
				return 0;
			end;
		end;
		return 1;
	else
		return 1;
	end;
end;


function StallCheckPermitRegion()
	if offlineCheckPermitRegion() == 1 then
		return 1
	else
		Talk(1, "", "不能在此区域摆摊")
	end
end

-- 获得一个位置相对于玩家位置的大体方位
function getDirection(posOrigin, posTarget)
	
	local tbStr = {"西南", "南", "东南", "东", "东北", "北", "西北", "西"};

	
	local nX	= posOrigin[2] - posTarget[2];
	local nY	= posTarget[1] - posOrigin[1];
	
	local nDeg	= atan2(posOrigin[2] - posTarget[2], posTarget[1] - posOrigin[1]);
	local nDirection = floor(nDeg/45+4.5);
	
	if (nDirection == 0) then
		nDirection = 8;
	end;
	
	-- 具体的距离，取整数
	local nDistance = floor(sqrt(nX*nX + nY*nY));
	
	return tbStr[nDirection], nDistance;
	
end;
